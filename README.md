# Benchmarking ATAC-seq peak calling
ATAC-seq (Assay for Transposase-Accessible Chromatin using Sequencing) is becoming increasing popular as a method to investigate the accessibility of DNA in different biological states. Our lab has been using ATAC-seq for the last couple of years to see how Drosophila chromatin changes in response to alcohol exposure (Yes, we get flies drunk! It's pretty interesting!). As our lab's bioinformatician, I have developed an in-house pipeline for our analysis needs. The pipeline is based off suggestions from ENCODE, Harvard FAS Informatics, and other scientific bodies/individuals. While most scientists agree about the majority of the steps needed to analyze ATAC-seq data, there is a huge question mark about how to identify accessible regions, also known as 'peaks.' Until very recently, the community simply tried to adapt tools originally intended for CHiP-seq data (MACS2, f-seq, ZINBA). This past year brought HMMRATAC, an ATAC-seq specific peak caller, as well as the unpublished Genrich, a new general peak-caller with an ATAC-seq option. The goal of this project is to benchmark the performance of common ATAC-seq peak-calling methods.
## Peak Callers
Based on published papers and message boards, MACS2 seems to be the most popular tool to analyze ATAC-seq peaks. Though unpublished, Genrich appears to be gaining traction among users. HMMRATAC is also increasingly mentioned, often with caveats about run time. This section is dedicated to these three methods (as well as multiple MACS2 options).
### MACS2
MACS2, or Model-based Analysis for ChIP-Seq, is the most well-known and -used tool for peak calling. As evidenced by its name, it was originally developed for ChIP-seq. It uses the Poisson distribution as the null basis for detecting genome biases and enrichment. A sliding window technique is employed to find more accessible regions. It was originally created by [Tao Liu](https://www.roswellpark.org/tao-liu).
One problem with MACS2 is that there is no consensus on how to use it with ATAC-seq. There are three commonly used options. First, the default is to use MACS2 in 'BAM' mode and extend each read fragment in both directions. This mode throws away half of properly paired data and has issues with false positive peaks due to fragments being shifted and extended. The second common method is to use 'BAMPE' mode. This method utilizes both reads of paired-end data and infers full fragments instead of cut sites. This method ignores any extension or read shift parameters. A third manner in which to use MACS2 for ATAC-seq is to use 'BED' mode. In this case, a paired-end BAM file is converted to a BED file, and then the extension and shift parameters can be used. It is, in a sense, the combination of the typical 'BAM' and 'BAMPE' methods.
### Genrich
Genrich was recently developed by [John Gaspar](https://github.com/jsh58), previous of Harvard FAS Informatics. The default method is for ChIP-seq peak-calling but there is an ATAC-seq specific mode which can be enabled by the `-j` parameter. To account for the manner in which the Tn5 enzyme inserts itself into the genome, Genrich centers a 100 bp interval on the end of each correlating fragment. It uses the log-normal distribution to calculate p-values for each base of the genome.
Some advantages over MACS include how much faster it runs (It is written in C), as well as the capability of calling peaks for multiple replicates collectively. Unfortunately, Genrich is yet to be published, creating some hesitancy among researchers.
### HMMRATAC
HMMRATAC is the only peak-caller designed specifically for ATAC-seq. It was developed by Eddie Tarbell and Tao Liu (of MACS2 fame). HMMRATAC uses a three-state Hidden Markov Model (HMM) to segment the genome into open chromatin regions, nucleosomal regions, and background regions. It employs a semi-supervised machine learning approach to train its HMM states.
Though HMMRATAC has much potential as a peak-caller, it is quite computationally intensive. It requires a lot of memory and often takes hours to run. HMMRATAC also creates a gappedPeak file rather than narrowPeak files like the tools above. While not inherently wrong, it does not easily lend itself to traditional peak understanding or differential peak finding.
## Materials and Methods
### Materials
The human GM12878 cell line ATAC-seq paired-end data used was publicly available and downloaded from three different datasets. The first three SRA accession numbers, SRR891269-SRR891271, were used in the [HMMRATAC paper](https://academic.oup.com/nar/article/47/16/e91/5519166#186843819) while two SRA samples, SRR5427884-SRR5427885, were used by Gaspar in his preprint, [Improving Peak-Calling with MACS2](https://www.biorxiv.org/content/10.1101/496521v1). Six replicates from the Parker lab's recent publication, [Quantification, Dynamic Visualization, and Validation of Bias in ATAC-Seq Data With Ataqv](https://pubmed.ncbi.nlm.nih.gov/32213349/), were also used (GSM3738821,GSM3738828,GSM3738835,GSM3738842,GSM3738849,GSM3738856).
### Preprocessing
I created a [Nextflow script]() to automate all of the preprocessing steps. To summarize, fastq pairs are first evaluated with [FastQC](https://github.com/s-andrews/FastQC). [TrimGalore](https://github.com/FelixKrueger/TrimGalore) is used to remove adapters and low quality reads from the fastq pairs. The reads are then aligned against the hg38 genome with [Bowtie2](http://bowtie-bio.sourceforge.net/bowtie2/manual.shtml) and sorted with [Samtools](http://www.htslib.org/doc/samtools-sort.html). [Picard](https://broadinstitute.github.io/picard/command-line-overview.html#MarkDuplicates) is used to remove duplicates. Note that for [Genrich](https://github.com/jsh58/Genrich), the bam file must be sorted by read names which is also accomplished with [Samtools](http://www.htslib.org/doc/samtools-sort.html) but with the parameter `-n`. Also, replicates were merged with [Samtools](http://www.htslib.org/doc/samtools-merge.html) and then preprocessed using the aforementioned steps.
### 'Gold Standard' Lists
The 'gold standard' dataset was downloaded from the supplementary data from the HMMRATAC paper, which was originally downloaded from the UCSC genome browser track wgEncodeBroadHmmGm12878HMM. This dataset, called 'active regions', is made by merging two chromatin states 'Active Promoters' and 'Strong Enhancers' generated by [chromHMM](http://compbio.mit.edu/ChromHMM/) in GM12878 cells.
The 'real negative' dataset was also downloaded from the supplementary data from the HMMRATAC paper. This set came from the 'Heterochromatin' state annotation from [chromHMM](http://compbio.mit.edu/ChromHMM/). As both BED files were originally created with the hg19 genome, I used the UCSC [LiftOver](https://genome.ucsc.edu/cgi-bin/hgLiftOver) tool to convert the coordinates to hg38.
### Find Peak Overlaps with 'Gold Standard'
Peaks in each peak file were combined (so as not to double count any region in the peaks) with `bedtools merge` after the peak file was sorted. `bedtools intersect -a GoldStandard -b peakFile -wo' was used to find the overlap between the peak regions and the Gold Standards (both active and closed). The `-wo` option is used to print out the length (in number of bases) of each region's overlap. `awk` is then used to tally up the total number of overlapping bases.
#### Calculations
Calculations were performed similarly to those in the HMMRATAC paper. Real positives (RP) were defined as the bases in the 'Gold Standard' active regions, and real negatives (RN) were defined as the bases in the 'Gold Standard' heterochromatin regions. True Positives (TP) are the bases which overlap between a called peak and real positives. False positives (FP) are bases which overlap between a called peak and the real negatives. 
Precision (PPV) was found with TP/(TP + FP). Recall (TPR) was found with TP/RP. False positive rate (FPR) was found with FP/RN. F1 score was found with 2 * ((PPV*TPR)/(PPV+TPR)). These calculations were calculated with `awk`.
PR (precision-recall) curves were generated in RStudio. The function `AUC` from the library `DescTools` was used to calculate the area under the curve for each curve.
### Find Coverage of Each Base in a Peak
`bedtools coverage` was used to find the coverage of each base of a peakset. Bases with a coverage <= 2 were labeled as false positives (bad). Bases with a coverage > 2 and <= 6 were labeled as 'okay'. Bases with a coverage > 6 were labeled as good. The percentage of each category was found for each peakset using `awk`.
## Results

## Conclusion

### Ideas
